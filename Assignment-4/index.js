var D=Object.defineProperty;var N=(h,t,e)=>t in h?D(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var n=(h,t,e)=>(N(h,typeof t!="symbol"?t+"":t,e),e);import{W as E,S as z,P as C,C as I,V as H,a as R,M as u,G as B,A as F,B as X,b as T,c,d as y,e as k,f as Y,g as Z,F as S,E as L,h as j,Q as A,O as G,i as W,D as U,T as v,j as J,k as O,l as V}from"./vendor.js";const K=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerpolicy&&(o.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?o.credentials="include":s.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}};K();class _{constructor(t=60,e=1.333,i=1,s=1e3){n(this,"aspectRatio");n(this,"fov");n(this,"znear");n(this,"zfar");n(this,"renderer");n(this,"scene");n(this,"camera");n(this,"clock");this.fov=t,this.aspectRatio=e,this.znear=i,this.zfar=s,this.renderer=new E,this.renderer.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(this.renderer.domElement),this.resize(),window.addEventListener("resize",()=>{this.resize()},!1),window.addEventListener("mousedown",o=>{this.onMouseDown(o)}),window.addEventListener("mouseup",o=>{this.onMouseUp(o)}),window.addEventListener("mousemove",o=>{this.onMouseMove(o)}),window.addEventListener("wheel",o=>{this.onMouseWheel(o)}),window.addEventListener("keydown",o=>{this.onKeyDown(o)}),window.addEventListener("keyup",o=>{this.onKeyUp(o)}),this.scene=new z,this.camera=new C(this.fov,this.aspectRatio,this.znear,this.zfar),this.clock=new I}start(){this.createScene(),this.mainLoop()}mainLoop(){this.update(this.clock.getDelta()),this.renderer.render(this.scene,this.camera),window.requestAnimationFrame(()=>this.mainLoop())}resize(){this.renderer.setSize(window.innerWidth,window.innerHeight);var t=new H;this.renderer.getViewport(t);var e=window.innerWidth/window.innerHeight;this.aspectRatio>e?this.renderer.setViewport(0,(window.innerHeight-window.innerWidth/this.aspectRatio)/2,window.innerWidth,window.innerWidth/this.aspectRatio):this.renderer.setViewport((window.innerWidth-window.innerHeight*this.aspectRatio)/2,0,window.innerHeight*this.aspectRatio,window.innerHeight)}onMouseDown(t){}onMouseUp(t){}onMouseMove(t){}onMouseWheel(t){}onKeyDown(t){}onKeyUp(t){}}class Q{constructor(t){n(this,"tokens");n(this,"line");n(this,"token");this.tokens=[],this.line=0,this.token=0;const e=t.split(`
`);for(let i=0;i<e.length;i++)this.tokens.push(e[i].trim().split(/\s+/));for(let i=0;i<this.tokens.length;i++)this.tokens[i].length==1&&this.tokens[i][0]==""&&(this.tokens.splice(i,1),i--)}peek(){return this.tokens[this.line][this.token]}expect(t){return this.peek()==t?(this.readToken(),!0):!1}consumeLine(){this.line++,this.token=0}done(){return this.line>=this.tokens.length}readToken(){const t=this.tokens[this.line][this.token];return this.token++,this.token>=this.tokens[this.line].length&&(this.line++,this.token=0),t}readNumber(){return Number(this.readToken())}readLine(){const t=[];for(let e=this.token;e<this.tokens[this.line].length;e++)t.push(this.tokens[this.line][e]);return this.line++,this.token=0,t}}class q{constructor(){n(this,"name");n(this,"direction");n(this,"length");n(this,"dofs");n(this,"children");n(this,"boneToRotationSpace");n(this,"rotationToBoneSpace");n(this,"transform");this.name="",this.direction=new R,this.length=0,this.dofs=[!1,!1,!1],this.children=[],this.boneToRotationSpace=new u,this.rotationToBoneSpace=new u,this.transform=new B}createAxes(){this.transform.add(new F(.15))}createGeometry(){const t=new X(.02,.02,this.length),e=new T({color:"black"}),i=new c(t,e);if(i.lookAt(this.direction),i.translateZ(-this.length/2),this.transform.add(i),this.name=="lowerback"){const s=this.createAntSection();s.rotateX(-60*Math.PI/180),s.translateY(-.01),s.translateZ(-.15),s.scale.set(1.3*this.length,1.3*this.length,2.7*this.length),this.transform.add(s)}else if(this.name=="upperback"){const s=this.createAntSection();s.translateY(.05),s.scale.set(this.length,this.length,this.length),this.transform.add(s)}else if(this.name=="thorax"){const s=this.createAntSection();s.translateY(.1),s.scale.set(.95*this.length,this.length,.95*this.length),this.transform.add(s)}else if(this.name=="head"){const s=this.createAntSection();s.rotateX(60*Math.PI/180),s.translateY(.1),s.scale.set(this.length,this.length,2*this.length),this.transform.add(s);const o=new T({color:"black"}),a=new c(new y,o);a.position.set(0,-.1,.19),a.scale.set(.04,.02,.02),this.transform.add(a);const d=new c(new y,o);d.position.set(.04,.13,.15),d.scale.set(.02,.02,.02),this.transform.add(d);const l=new c(new y,o);l.position.set(-.04,.13,.15),l.scale.set(.02,.02,.02),this.transform.add(l);const r=new c(new k(1,2),o);r.position.set(.08,.25,.07),r.rotateX(20*Math.PI/180),r.rotateZ(-30*Math.PI/180),r.scale.set(.02,.1,.02),this.transform.add(r);const f=new c(new k(1,2),o);f.position.set(.1105,.305,.07),f.rotateX(70*Math.PI/180),f.translateY(.1),f.translateZ(.01),f.scale.set(.02,.1,.02),this.transform.add(f);const g=new c(new k(1,2),o);g.position.set(-.08,.25,.07),g.rotateX(20*Math.PI/180),g.rotateZ(30*Math.PI/180),g.scale.set(.02,.1,.02),this.transform.add(g);const p=new c(new k(1,2),o);p.position.set(-.1105,.305,.07),p.rotateX(70*Math.PI/180),p.translateY(.1),p.translateZ(.01),p.scale.set(.02,.1,.02),this.transform.add(p)}}createAntSection(){const t=new Y;return t.color=new Z(.7,0,0),t.shininess=50,new c(new y,t)}createHierarchy(t){this.resetTransform(),t.add(this.transform),this.children.forEach(e=>{e.createHierarchy(this.transform)})}update(t){this.resetTransform(),this.transform.applyMatrix4(this.boneToRotationSpace),this.transform.applyMatrix4(t.getJointRotation(this.name)),this.transform.applyMatrix4(this.rotationToBoneSpace),this.children.forEach(e=>{e.update(t)})}resetTransform(){this.transform.position.copy(this.direction),this.transform.position.multiplyScalar(this.length),this.transform.rotation.set(0,0,0)}}const b=class{constructor(t,e=!1){n(this,"loaded");n(this,"usingDegrees");n(this,"showAxes");n(this,"bones");n(this,"rootPosition");n(this,"rootRotation");n(this,"rootTransform");n(this,"rootBones");this.loaded=!1,this.usingDegrees=!1,this.showAxes=e,this.bones=new Map,this.rootPosition=new R,this.rootRotation=new u,this.rootTransform=new B,this.rootBones=[],t.add(this.rootTransform),e&&this.rootTransform.add(new F(.15))}static finishedLoading(){return b.numLoading==0}loadFromASF(t){console.log("Loading skeleton data from "+t+"..."),b.numLoading++,new S().load(t,i=>{const s=new Q(i);for(;!s.done();){const o=s.readToken();if(o.charAt(0)=="#")s.consumeLine();else if(o==":units")this.parseUnits(s);else if(o==":root")this.parseRoot(s);else if(o==":bonedata")this.parseBoneData(s);else if(o==":hierarchy")this.parseHierarchy(s);else if(o==":version")s.consumeLine();else if(o==":name")s.consumeLine();else if(o==":documentation")for(;!s.done()&&s.peek().charAt(0)!=":";)s.consumeLine();else{console.error("Error: encountered unknown token: "+o);return}}console.log("Skeleton data loaded from "+t+"."),b.numLoading--,this.createHierarchy()})}parseUnits(t){let e;do e=!0,t.expect("mass")||t.expect("length")?(e=!1,t.consumeLine()):t.expect("angle")&&(e=!1,this.usingDegrees=t.readToken()=="deg");while(!e)}parseRoot(t){let e;do if(e=!0,t.expect("order")){if(e=!1,!t.expect("TX")||!t.expect("TY")||!t.expect("TZ")||!t.expect("RX")||!t.expect("RY")||!t.expect("RZ")){console.error("Error: order not in the order expected");return}}else if(t.expect("axis")){if(e=!1,!t.expect("XYZ")){console.error("Error: axis not in the order expected");return}}else if(t.expect("position"))e=!1,this.rootPosition.set(t.readNumber(),t.readNumber(),t.readNumber()),this.rootPosition.multiplyScalar(.056444);else if(t.expect("orientation")){e=!1;const i=new L(t.readNumber(),t.readNumber(),t.readNumber(),"ZYX");this.rootRotation.makeRotationFromEuler(i)}while(!e)}parseBoneData(t){for(;t.expect("begin");){const e=new q;for(;!t.expect("end");)if(t.expect("id"))t.consumeLine();else if(t.expect("name")){const i=t.readToken();e.name=i,this.bones.set(i,e)}else if(t.expect("direction"))e.direction.x=t.readNumber(),e.direction.y=t.readNumber(),e.direction.z=t.readNumber();else if(t.expect("length"))e.length=t.readNumber()*.056444;else if(t.expect("axis")){let i=t.readNumber(),s=t.readNumber(),o=t.readNumber();if(this.usingDegrees&&(i*=Math.PI/180,s*=Math.PI/180,o*=Math.PI/180),t.expect("XYZ")){const a=new L(i,s,o,"ZYX");e.rotationToBoneSpace.makeRotationFromEuler(a),e.boneToRotationSpace.copy(e.rotationToBoneSpace),e.boneToRotationSpace.invert()}else{console.error("Error: bone axis not in the order expected");return}}else t.expect("dof")?(e.dofs[0]=t.expect("rx"),e.dofs[1]=t.expect("ry"),e.dofs[2]=t.expect("rz")):t.expect("limits")&&(e.dofs[0]&&t.consumeLine(),e.dofs[1]&&t.consumeLine(),e.dofs[2]&&t.consumeLine());this.showAxes?e.createAxes():e.createGeometry()}}parseHierarchy(t){if(t.expect("begin"))for(;!t.expect("end");){const e=t.readToken();t.readLine().forEach(s=>{if(e=="root"){const o=this.bones.get(s);this.rootBones.push(o)}else{const o=this.bones.get(s);this.bones.get(e).children.push(o)}})}else console.error("Error: reading hierarchy, expected begin, found "+t.peek())}getBone(t){return this.bones.get(t)}createHierarchy(){this.rootBones.forEach(t=>{t.createHierarchy(this.rootTransform)})}update(t,e){this.rootTransform.rotation.set(0,0,0),this.rootTransform.applyMatrix4(this.rootRotation),this.rootTransform.applyMatrix4(t.rootRotation),e&&(this.rootTransform.position.copy(this.rootPosition),this.rootTransform.applyMatrix4(t.rootTranslation)),this.rootBones.forEach(i=>{i.update(t)})}};let x=b;n(x,"numLoading",0);class M{constructor(){n(this,"frame");n(this,"rootTranslation");n(this,"rootRotation");n(this,"jointRotations");this.frame=0,this.rootTranslation=new u,this.rootRotation=new u,this.jointRotations=new Map}setRootPosition(t){this.rootTranslation.makeTranslation(t.x,t.y,t.z)}getRootPosition(){const t=new R;return t.applyMatrix4(this.rootTranslation),t}setRootAngles(t){this.rootRotation.makeRotationFromEuler(t)}setJointAngles(t,e){const i=new u().makeRotationFromEuler(e);this.jointRotations.set(t.name,i)}getJointRotation(t){const e=this.jointRotations.get(t);return e||new u}setJointRotation(t,e){this.jointRotations.set(t,e)}lerp(t,e){this.frame=Math.round(j.lerp(this.frame,t.frame,e));const i=this.getRootPosition();i.lerp(t.getRootPosition(),e),this.rootTranslation.makeTranslation(i.x,i.y,i.z);const s=new A().setFromRotationMatrix(this.rootRotation);s.slerp(new A().setFromRotationMatrix(t.rootRotation),e),this.rootRotation.makeRotationFromQuaternion(s),this.jointRotations.forEach((o,a)=>{const d=new A().setFromRotationMatrix(o);d.slerp(new A().setFromRotationMatrix(t.getJointRotation(a)),e),o.makeRotationFromQuaternion(d)})}clone(){const t=new M;return t.frame=this.frame,t.rootRotation.copy(this.rootRotation),t.rootTranslation.copy(this.rootTranslation),this.jointRotations.forEach((e,i)=>{t.setJointRotation(i,e.clone())}),t}}const w=class{constructor(){n(this,"frames");this.frames=[]}static finishedLoading(){return w.numLoading==0}loadFromAMC(t,e){console.log("Loading motion data from "+t+"..."),w.numLoading++,new S().load(t,s=>{const o=new Q(s);for(;!o.done();){for(;o.peek().charAt(0)=="#"||o.peek().charAt(0)==":";)o.consumeLine();for(;!o.done();){const a=new M;for(a.frame=o.readNumber();!o.done()&&isNaN(Number(o.peek()));){const d=o.readToken();if(d=="root"){const l=new R;l.x=o.readNumber()*.056444,l.y=o.readNumber()*.056444,l.z=o.readNumber()*.056444,a.setRootPosition(l);const r=new L;r.order="ZYX",r.x=o.readNumber()*Math.PI/180,r.y=o.readNumber()*Math.PI/180,r.z=o.readNumber()*Math.PI/180,a.setRootAngles(r)}else{const l=e.getBone(d),r=new L;r.order="ZYX",l.dofs[0]&&(r.x=o.readNumber()*Math.PI/180),l.dofs[1]&&(r.y=o.readNumber()*Math.PI/180),l.dofs[2]&&(r.z=o.readNumber()*Math.PI/180),a.setJointAngles(l,r)}}this.frames.push(a)}}console.log("Motion data loaded from "+t+"."),w.numLoading--})}trimFront(t){this.frames.splice(0,t)}trimBack(t){this.frames.splice(this.frames.length-t,t)}prependPose(t){this.frames.unshift(t)}appendPose(t){this.frames.push(t)}makeLoop(t){const e=new w;for(let i=0;i<t;i++)e.prependPose(this.frames.pop());for(let i=0;i<t;i++){const s=i/(e.frames.length-1);e.frames[i].lerp(this.frames[i],s),this.frames[i]=e.frames[i]}}};let m=w;n(m,"numLoading",0);class P extends G{constructor(t=60,e=!0,i=!1){super();n(this,"skeleton");n(this,"fps");n(this,"useAbsolutePosition");n(this,"clip");n(this,"currentTime");n(this,"currentPose");n(this,"overlayQueue");n(this,"overlayTransitionFrames");n(this,"overlayTime");n(this,"overlayPose");this.skeleton=new x(this,i),this.fps=t,this.useAbsolutePosition=e,this.clip=null,this.currentTime=0,this.currentPose=new M,this.overlayQueue=[],this.overlayTransitionFrames=[],this.overlayTime=0,this.overlayPose=new M}loadSkeleton(t){this.skeleton.loadFromASF(t)}loadMotionClip(t){const e=new m;return e.loadFromAMC(t,this.skeleton),e}play(t){this.stop(),this.clip=t,this.currentPose=this.clip.frames[0]}stop(){this.clip=null,this.currentTime=0,this.overlayQueue=[],this.overlayTransitionFrames=[],this.overlayTime=0}overlay(t,e){this.overlayQueue.push(t),this.overlayTransitionFrames.push(e)}update(t){if(!this.clip)return;this.currentTime+=t;let e=Math.floor(this.currentTime*this.fps);e>=this.clip.frames.length&&(e=0,this.currentTime=0,this.currentPose=this.clip.frames[0]);let i=0;this.overlayQueue.length>0&&(this.overlayTime+=t,i=Math.floor(this.overlayTime*this.fps),i>=this.overlayQueue[0].frames.length&&(this.overlayQueue.shift(),this.overlayTransitionFrames.shift(),this.overlayTime=0,i=0));const s=this.computePose(e,i);this.skeleton.update(s,this.useAbsolutePosition)}getQueueCount(){return this.overlayQueue.length}computePose(t,e){if(this.overlayQueue.length>0){const i=this.overlayQueue[0].frames[e].clone();let s=0;if(e<this.overlayTransitionFrames[0]?(s=1-e/this.overlayTransitionFrames[0],i.lerp(this.clip.frames[t],s)):e>this.overlayQueue[0].frames.length-this.overlayTransitionFrames[0]&&(s=1-(this.overlayQueue[0].frames.length-e)/this.overlayTransitionFrames[0],i.lerp(this.clip.frames[t],s)),!this.useAbsolutePosition){const o=this.overlayQueue[0].frames[e].getRootPosition();o.sub(this.overlayPose.getRootPosition());const a=this.clip.frames[t].getRootPosition();a.sub(this.currentPose.getRootPosition()),o.lerpVectors(o,a,s),this.position.add(o),this.overlayPose=this.overlayQueue[0].frames[e],this.currentPose=this.clip.frames[t]}return i}else{if(!this.useAbsolutePosition){const i=this.clip.frames[t].getRootPosition();i.sub(this.currentPose.getRootPosition()),this.position.add(i),this.currentPose=this.clip.frames[t]}return this.clip.frames[t]}}}class $ extends _{constructor(){super(60,1920/1080,.1,100);n(this,"salsaAntLead");n(this,"salsaAntFollow");n(this,"balletAnt");n(this,"salsaMotionLead");n(this,"salsaMotionFollow");n(this,"balletBaseLoop");n(this,"balletDanceMotions");n(this,"state");const t=!1;this.salsaAntLead=new P(60,!0,t),this.salsaAntFollow=new P(60,!0,t),this.balletAnt=new P(120,!1,t),this.salsaMotionLead=new m,this.salsaMotionFollow=new m,this.balletBaseLoop=new m,this.balletDanceMotions=[],this.state=0}createScene(){this.camera.position.set(0,1.5,3.5),this.camera.lookAt(0,1,0),this.camera.up.set(0,1,0);const t=new W("white",.3);this.scene.add(t);const e=new U("white",.6);e.position.set(0,2,1),this.scene.add(e),this.scene.background=new v().load("assets/images/ants-dance.jpg");const i=new J;i.map=new v().load("assets/images/woodfloor.jpg");const s=new c(new O(14,6));s.material=i,s.rotateX(-Math.PI/2),this.scene.add(s);const o=new V;o.width=100;const a=o.addFolder("Ballet Controls");a.open(),a.add(this,"playBalletMotion1").name("Motion 1"),a.add(this,"playBalletMotion2").name("Motion 2"),a.add(this,"playBalletMotion3").name("Motion 3"),a.add(this,"playBalletMotion4").name("Motion 4"),a.add(this,"playBalletMotion5").name("Motion 5"),this.salsaAntLead.position.set(1,0,.5),this.salsaAntFollow.position.set(1,0,.5),this.balletAnt.position.set(-2,.95,0),this.loadSkeletons()}loadSkeletons(){this.state=1,this.salsaAntLead.loadSkeleton("./assets/data/60.asf"),this.salsaAntFollow.loadSkeleton("./assets/data/61.asf"),this.balletAnt.loadSkeleton("./assets/data/61.asf")}loadAnimations(){this.state=2,this.salsaMotionLead=this.salsaAntLead.loadMotionClip("./assets/data/60_12.amc"),this.salsaMotionFollow=this.salsaAntLead.loadMotionClip("./assets/data/61_12.amc"),this.balletBaseLoop=this.balletAnt.loadMotionClip("./assets/data/05_20.amc"),this.balletDanceMotions.push(this.balletAnt.loadMotionClip("./assets/data/05_02.amc")),this.balletDanceMotions.push(this.balletAnt.loadMotionClip("./assets/data/05_10.amc")),this.balletDanceMotions.push(this.balletAnt.loadMotionClip("./assets/data/05_09.amc")),this.balletDanceMotions.push(this.balletAnt.loadMotionClip("./assets/data/05_20.amc")),this.balletDanceMotions.push(this.balletAnt.loadMotionClip("./assets/data/05_06.amc"))}startAnimations(){this.salsaMotionLead.trimFront(100),this.salsaMotionLead.trimBack(150),this.salsaMotionLead.makeLoop(100),this.salsaMotionFollow.trimFront(100),this.salsaMotionFollow.trimBack(150),this.salsaMotionFollow.makeLoop(100),this.balletBaseLoop.trimBack(600),this.balletBaseLoop.makeLoop(50),this.balletDanceMotions[0].trimFront(280),this.balletDanceMotions[0].trimBack(200),this.balletDanceMotions[1].trimFront(60),this.balletDanceMotions[1].trimBack(60),this.balletDanceMotions[2].trimFront(350),this.balletDanceMotions[3].trimFront(450),this.balletDanceMotions[4].trimBack(60),this.salsaAntLead.play(this.salsaMotionLead),this.salsaAntFollow.play(this.salsaMotionFollow),this.balletAnt.play(this.balletBaseLoop),this.scene.add(this.salsaAntLead),this.scene.add(this.salsaAntFollow),this.scene.add(this.balletAnt)}update(t){if(this.state!=0){if(this.state==1)if(x.finishedLoading())this.loadAnimations();else return;if(this.state==2)if(m.finishedLoading())this.state=3,this.startAnimations();else return;this.salsaAntLead.update(t),this.salsaAntFollow.update(t),this.balletAnt.update(t)}}playBalletMotion1(){this.balletAnt.overlay(this.balletDanceMotions[0],100),console.log("Queueing ballet motion 1. Queue size is "+this.balletAnt.getQueueCount()+".")}playBalletMotion2(){this.balletAnt.overlay(this.balletDanceMotions[1],100),console.log("Queueing ballet motion 2. Queue size is "+this.balletAnt.getQueueCount()+".")}playBalletMotion3(){this.balletAnt.overlay(this.balletDanceMotions[2],100),console.log("Queueing ballet motion 3. Queue size is "+this.balletAnt.getQueueCount()+".")}playBalletMotion4(){this.balletAnt.overlay(this.balletDanceMotions[3],100),console.log("Queueing ballet motion 4. Queue size is "+this.balletAnt.getQueueCount()+".")}playBalletMotion5(){this.balletAnt.overlay(this.balletDanceMotions[4],100),console.log("Queueing ballet motion 5. Queue size is "+this.balletAnt.getQueueCount()+".")}}var tt=new $;tt.start();
