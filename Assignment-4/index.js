var A=Object.defineProperty;var v=(r,t,e)=>t in r?A(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var n=(r,t,e)=>(v(r,typeof t!="symbol"?t+"":t,e),e);import{W as F,S as P,P as B,C as D,V as N,a as g,M as c,G as L,A as x,F as R,E as w,b as C,Q as u,O as S,c as E,D as z,T as k,d as H,e as I,f as j,g as W}from"./vendor.js";const X=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerpolicy&&(o.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?o.credentials="include":s.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}};X();class U{constructor(t=60,e=1.333,i=1,s=1e3){n(this,"aspectRatio");n(this,"fov");n(this,"znear");n(this,"zfar");n(this,"renderer");n(this,"scene");n(this,"camera");n(this,"clock");this.fov=t,this.aspectRatio=e,this.znear=i,this.zfar=s,this.renderer=new F,this.renderer.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(this.renderer.domElement),this.resize(),window.addEventListener("resize",()=>{this.resize()},!1),window.addEventListener("mousedown",o=>{this.onMouseDown(o)}),window.addEventListener("mouseup",o=>{this.onMouseUp(o)}),window.addEventListener("mousemove",o=>{this.onMouseMove(o)}),window.addEventListener("wheel",o=>{this.onMouseWheel(o)}),window.addEventListener("keydown",o=>{this.onKeyDown(o)}),window.addEventListener("keyup",o=>{this.onKeyUp(o)}),this.scene=new P,this.camera=new B(this.fov,this.aspectRatio,this.znear,this.zfar),this.clock=new D}start(){this.createScene(),this.mainLoop()}mainLoop(){this.update(this.clock.getDelta()),this.renderer.render(this.scene,this.camera),window.requestAnimationFrame(()=>this.mainLoop())}resize(){this.renderer.setSize(window.innerWidth,window.innerHeight);var t=new N;this.renderer.getViewport(t);var e=window.innerWidth/window.innerHeight;this.aspectRatio>e?this.renderer.setViewport(0,(window.innerHeight-window.innerWidth/this.aspectRatio)/2,window.innerWidth,window.innerWidth/this.aspectRatio):this.renderer.setViewport((window.innerWidth-window.innerHeight*this.aspectRatio)/2,0,window.innerHeight*this.aspectRatio,window.innerHeight)}onMouseDown(t){}onMouseUp(t){}onMouseMove(t){}onMouseWheel(t){}onKeyDown(t){}onKeyUp(t){}}class T{constructor(t){n(this,"tokens");n(this,"line");n(this,"token");this.tokens=[],this.line=0,this.token=0;const e=t.split(`
`);for(let i=0;i<e.length;i++)this.tokens.push(e[i].trim().split(/\s+/));for(let i=0;i<this.tokens.length;i++)this.tokens[i].length==1&&this.tokens[i][0]==""&&(this.tokens.splice(i,1),i--)}peek(){return this.tokens[this.line][this.token]}expect(t){return this.peek()==t?(this.readToken(),!0):!1}consumeLine(){this.line++,this.token=0}done(){return this.line>=this.tokens.length}readToken(){const t=this.tokens[this.line][this.token];return this.token++,this.token>=this.tokens[this.line].length&&(this.line++,this.token=0),t}readNumber(){return Number(this.readToken())}readLine(){const t=[];for(let e=this.token;e<this.tokens[this.line].length;e++)t.push(this.tokens[this.line][e]);return this.line++,this.token=0,t}}class Y{constructor(){n(this,"name");n(this,"direction");n(this,"length");n(this,"dofs");n(this,"children");n(this,"boneToRotationSpace");n(this,"rotationToBoneSpace");n(this,"transform");this.name="",this.direction=new g,this.length=0,this.dofs=[!1,!1,!1],this.children=[],this.boneToRotationSpace=new c,this.rotationToBoneSpace=new c,this.transform=new L,this.transform.add(new x(.15))}createHierarchy(t){this.resetTransform(),t.add(this.transform),this.children.forEach(e=>{e.createHierarchy(this.transform)})}update(t){this.resetTransform(),this.transform.applyMatrix4(this.boneToRotationSpace),this.transform.applyMatrix4(t.getJointRotation(this.name)),this.transform.applyMatrix4(this.rotationToBoneSpace),this.children.forEach(e=>{e.update(t)})}resetTransform(){this.transform.position.copy(this.direction),this.transform.position.multiplyScalar(this.length),this.transform.rotation.set(0,0,0)}}const f=class{constructor(t){n(this,"loaded");n(this,"usingDegrees");n(this,"bones");n(this,"rootPosition");n(this,"rootRotation");n(this,"rootTransform");n(this,"rootBones");this.loaded=!1,this.usingDegrees=!1,this.bones=new Map,this.rootPosition=new g,this.rootRotation=new c,this.rootTransform=new L,this.rootBones=[],t.add(this.rootTransform),this.rootTransform.add(new x(.15))}static finishedLoading(){return f.numLoading==0}loadFromASF(t){console.log("Loading skeleton data from "+t+"..."),f.numLoading++,new R().load(t,i=>{const s=new T(i);for(;!s.done();){const o=s.readToken();if(o.charAt(0)=="#")s.consumeLine();else if(o==":units")this.parseUnits(s);else if(o==":root")this.parseRoot(s);else if(o==":bonedata")this.parseBoneData(s);else if(o==":hierarchy")this.parseHierarchy(s);else if(o==":version")s.consumeLine();else if(o==":name")s.consumeLine();else if(o==":documentation")for(;!s.done()&&s.peek().charAt(0)!=":";)s.consumeLine();else{console.error("Error: encountered unknown token: "+o);return}}console.log("Skeleton data loaded from "+t+"."),f.numLoading--,this.createHierarchy()})}parseUnits(t){let e;do e=!0,t.expect("mass")||t.expect("length")?(e=!1,t.consumeLine()):t.expect("angle")&&(e=!1,this.usingDegrees=t.readToken()=="deg");while(!e)}parseRoot(t){let e;do if(e=!0,t.expect("order")){if(e=!1,!t.expect("TX")||!t.expect("TY")||!t.expect("TZ")||!t.expect("RX")||!t.expect("RY")||!t.expect("RZ")){console.error("Error: order not in the order expected");return}}else if(t.expect("axis")){if(e=!1,!t.expect("XYZ")){console.error("Error: axis not in the order expected");return}}else if(t.expect("position"))e=!1,this.rootPosition.set(t.readNumber(),t.readNumber(),t.readNumber()),this.rootPosition.multiplyScalar(.056444);else if(t.expect("orientation")){e=!1;const i=new w(t.readNumber(),t.readNumber(),t.readNumber(),"ZYX");this.rootRotation.makeRotationFromEuler(i)}while(!e)}parseBoneData(t){for(;t.expect("begin");){const e=new Y;for(;!t.expect("end");)if(t.expect("id"))t.consumeLine();else if(t.expect("name")){const i=t.readToken();e.name=i,this.bones.set(i,e)}else if(t.expect("direction"))e.direction.x=t.readNumber(),e.direction.y=t.readNumber(),e.direction.z=t.readNumber();else if(t.expect("length"))e.length=t.readNumber()*.056444;else if(t.expect("axis")){let i=t.readNumber(),s=t.readNumber(),o=t.readNumber();if(this.usingDegrees&&(i*=Math.PI/180,s*=Math.PI/180,o*=Math.PI/180),t.expect("XYZ")){const a=new w(i,s,o,"ZYX");e.rotationToBoneSpace.makeRotationFromEuler(a),e.boneToRotationSpace.copy(e.rotationToBoneSpace),e.boneToRotationSpace.invert()}else{console.error("Error: bone axis not in the order expected");return}}else t.expect("dof")?(e.dofs[0]=t.expect("rx"),e.dofs[1]=t.expect("ry"),e.dofs[2]=t.expect("rz")):t.expect("limits")&&(e.dofs[0]&&t.consumeLine(),e.dofs[1]&&t.consumeLine(),e.dofs[2]&&t.consumeLine())}}parseHierarchy(t){if(t.expect("begin"))for(;!t.expect("end");){const e=t.readToken();t.readLine().forEach(s=>{if(e=="root"){const o=this.bones.get(s);this.rootBones.push(o)}else{const o=this.bones.get(s);this.bones.get(e).children.push(o)}})}else console.error("Error: reading hierarchy, expected begin, found "+t.peek())}getBone(t){return this.bones.get(t)}createHierarchy(){this.rootBones.forEach(t=>{t.createHierarchy(this.rootTransform)})}update(t){this.rootTransform.position.copy(this.rootPosition),this.rootTransform.rotation.set(0,0,0),this.rootTransform.applyMatrix4(this.rootRotation),this.rootTransform.applyMatrix4(t.rootRotation),this.rootTransform.applyMatrix4(t.rootTranslation),this.rootBones.forEach(e=>{e.update(t)})}};let b=f;n(b,"numLoading",0);class y{constructor(){n(this,"frame");n(this,"rootTranslation");n(this,"rootRotation");n(this,"jointRotations");this.frame=0,this.rootTranslation=new c,this.rootRotation=new c,this.jointRotations=new Map}setRootPosition(t){this.rootTranslation.makeTranslation(t.x,t.y,t.z)}getRootPosition(){const t=new g;return t.applyMatrix4(this.rootTranslation),t}setRootAngles(t){this.rootRotation.makeRotationFromEuler(t)}setJointAngles(t,e){const i=new c().makeRotationFromEuler(e);this.jointRotations.set(t.name,i)}getJointRotation(t){const e=this.jointRotations.get(t);return e||new c}setJointRotation(t,e){this.jointRotations.set(t,e)}lerp(t,e){this.frame=Math.round(C.lerp(this.frame,t.frame,e));const i=this.getRootPosition();i.lerp(t.getRootPosition(),e),this.rootTranslation.makeTranslation(i.x,i.y,i.z);const s=new u().setFromRotationMatrix(this.rootRotation);s.slerp(new u().setFromRotationMatrix(t.rootRotation),e),this.rootRotation.makeRotationFromQuaternion(s),this.jointRotations.forEach((o,a)=>{const p=new u().setFromRotationMatrix(o);p.slerp(new u().setFromRotationMatrix(t.getJointRotation(a)),e),o.makeRotationFromQuaternion(p)})}clone(){const t=new y;return t.frame=this.frame,t.rootRotation.copy(this.rootRotation),t.rootTranslation.copy(this.rootTranslation),this.jointRotations.forEach((e,i)=>{t.setJointRotation(i,e.clone())}),t}}const m=class{constructor(){n(this,"frames");this.frames=[]}static finishedLoading(){return m.numLoading==0}loadFromAMC(t,e){console.log("Loading motion data from "+t+"..."),m.numLoading++,new R().load(t,s=>{const o=new T(s);for(;!o.done();){for(;o.peek().charAt(0)=="#"||o.peek().charAt(0)==":";)o.consumeLine();for(;!o.done();){const a=new y;for(a.frame=o.readNumber();!o.done()&&isNaN(Number(o.peek()));){const p=o.readToken();if(p=="root"){const h=new g;h.x=o.readNumber()*.056444,h.y=o.readNumber()*.056444,h.z=o.readNumber()*.056444,a.setRootPosition(h);const l=new w;l.order="ZYX",l.x=o.readNumber()*Math.PI/180,l.y=o.readNumber()*Math.PI/180,l.z=o.readNumber()*Math.PI/180,a.setRootAngles(l)}else{const h=e.getBone(p),l=new w;l.order="ZYX",h.dofs[0]&&(l.x=o.readNumber()*Math.PI/180),h.dofs[1]&&(l.y=o.readNumber()*Math.PI/180),h.dofs[2]&&(l.z=o.readNumber()*Math.PI/180),a.setJointAngles(h,l)}}this.frames.push(a)}}console.log("Motion data loaded from "+t+"."),m.numLoading--})}trimFront(t){this.frames.splice(0,t)}trimBack(t){this.frames.splice(this.frames.length-t,t)}prependPose(t){this.frames.unshift(t)}appendPose(t){this.frames.push(t)}makeLoop(t){const e=new m;for(let i=0;i<t;i++)e.prependPose(this.frames.pop());for(let i=0;i<t;i++){const s=i/(e.frames.length-1);e.frames[i].lerp(this.frames[i],s),this.frames[i]=e.frames[i]}}};let d=m;n(d,"numLoading",0);class M extends S{constructor(){super();n(this,"skeleton");n(this,"fps");n(this,"clip");n(this,"currentTime");n(this,"overlayClip");n(this,"overlayTime");n(this,"overlayTransitionFrames");this.skeleton=new b(this),this.fps=60,this.clip=null,this.currentTime=0,this.overlayClip=null,this.overlayTime=0,this.overlayTransitionFrames=0}loadSkeleton(t){this.skeleton.loadFromASF(t)}loadMotionClip(t){const e=new d;return e.loadFromAMC(t,this.skeleton),e}play(t){this.stop(),this.clip=t}stop(){this.clip=null,this.currentTime=0,this.overlayClip=null,this.overlayTime=0,this.overlayTransitionFrames=0}overlay(t,e){this.overlayClip=t,this.overlayTime=0,this.overlayTransitionFrames=e}update(t){if(!this.clip)return;this.currentTime+=t;let e=Math.floor(this.currentTime*this.fps);e>=this.clip.frames.length&&(e=0,this.currentTime=0);let i=0;this.overlayClip&&(this.overlayTime+=t,i=Math.floor(this.overlayTime*this.fps),i>=this.overlayClip.frames.length&&(this.overlayClip=null,this.overlayTime=0));const s=this.computeCurrentPose(e,i);this.skeleton.update(s)}computeCurrentPose(t,e){if(this.overlayClip){const i=this.overlayClip.frames[e].clone();if(e<this.overlayTransitionFrames){const s=1-e/this.overlayTransitionFrames;i.lerp(this.clip.frames[t],s)}else if(e>this.overlayClip.frames.length-this.overlayTransitionFrames){const s=1-(this.overlayClip.frames.length-e)/this.overlayTransitionFrames;i.lerp(this.clip.frames[t],s)}return this.overlayClip.frames[e]}else return this.clip.frames[t]}}class Z extends U{constructor(){super(60,1920/1080,.1,100);n(this,"salsaAntLead");n(this,"salsaAntFollow");n(this,"balletAnt");n(this,"salsaMotionLead");n(this,"salsaMotionFollow");n(this,"balletBaseLoop");n(this,"balletDanceMotions");n(this,"state");this.salsaAntLead=new M,this.salsaAntFollow=new M,this.balletAnt=new M,this.salsaMotionLead=new d,this.salsaMotionFollow=new d,this.balletBaseLoop=new d,this.balletDanceMotions=[],this.state=0}createScene(){this.camera.position.set(0,1.5,3.5),this.camera.lookAt(0,1,0),this.camera.up.set(0,1,0);const t=new E("white",.3);this.scene.add(t);const e=new z("white",.6);e.position.set(0,2,1),this.scene.add(e),this.scene.background=new k().load("assets/images/ants-dance.jpg");const i=new H;i.map=new k().load("assets/images/woodfloor.jpg");const s=new I(new j(14,6));s.material=i,s.rotateX(-Math.PI/2),this.scene.add(s);const o=new W;o.width=100;const a=o.addFolder("Ballet Controls");a.open(),a.add(this,"playBalletMotion1").name("Motion 1"),a.add(this,"playBalletMotion2").name("Motion 2"),a.add(this,"playBalletMotion3").name("Motion 3"),a.add(this,"playBalletMotion4").name("Motion 4"),a.add(this,"playBalletMotion5").name("Motion 5"),this.salsaAntLead.position.set(1,0,.5),this.salsaAntFollow.position.set(1,0,.5),this.balletAnt.position.set(-1,0,0),this.loadSkeletons()}loadSkeletons(){this.state=1,this.salsaAntLead.loadSkeleton("./assets/data/60.asf"),this.salsaAntFollow.loadSkeleton("./assets/data/61.asf"),this.balletAnt.loadSkeleton("./assets/data/61.asf")}loadAnimations(){this.state=2,this.salsaMotionLead=this.salsaAntLead.loadMotionClip("./assets/data/60_12.amc"),this.salsaMotionFollow=this.salsaAntLead.loadMotionClip("./assets/data/61_12.amc"),this.balletBaseLoop=this.balletAnt.loadMotionClip("./assets/data/05_20.amc"),this.balletDanceMotions.push(this.balletAnt.loadMotionClip("/assets/data/05_02.amc")),this.balletDanceMotions.push(this.balletAnt.loadMotionClip("/assets/data/05_10.amc")),this.balletDanceMotions.push(this.balletAnt.loadMotionClip("/assets/data/05_09.amc")),this.balletDanceMotions.push(this.balletAnt.loadMotionClip("/assets/data/05_20.amc")),this.balletDanceMotions.push(this.balletAnt.loadMotionClip("/assets/data/05_06.amc"))}startAnimations(){this.salsaMotionLead.trimFront(100),this.salsaMotionLead.trimBack(150),this.salsaMotionLead.makeLoop(100),this.salsaAntLead.play(this.salsaMotionLead),this.salsaMotionFollow.trimFront(100),this.salsaMotionFollow.trimBack(150),this.salsaMotionFollow.makeLoop(100),this.salsaAntFollow.play(this.salsaMotionFollow),this.balletBaseLoop.trimBack(600),this.balletBaseLoop.makeLoop(50),this.balletAnt.play(this.balletBaseLoop),this.balletDanceMotions[0].trimFront(280),this.balletDanceMotions[0].trimBack(200),this.balletDanceMotions[1].trimFront(60),this.balletDanceMotions[1].trimBack(60),this.balletDanceMotions[2].trimFront(350),this.balletDanceMotions[3].trimFront(450),this.balletDanceMotions[4].trimBack(60),this.scene.add(this.salsaAntLead),this.scene.add(this.salsaAntFollow),this.scene.add(this.balletAnt)}update(t){if(this.state!=0){if(this.state==1)if(b.finishedLoading())this.loadAnimations();else return;if(this.state==2)if(d.finishedLoading())this.state=3,this.startAnimations();else return;this.salsaAntLead.update(t),this.salsaAntFollow.update(t),this.balletAnt.update(t)}}playBalletMotion1(){console.log("Playing ballet motion 1."),this.balletAnt.overlay(this.balletDanceMotions[0],100)}playBalletMotion2(){console.log("Playing ballet motion 2."),this.balletAnt.overlay(this.balletDanceMotions[1],100)}playBalletMotion3(){console.log("Playing ballet motion 3."),this.balletAnt.overlay(this.balletDanceMotions[2],100)}playBalletMotion4(){console.log("Playing ballet motion 4."),this.balletAnt.overlay(this.balletDanceMotions[3],100)}playBalletMotion5(){console.log("Playing ballet motion 5."),this.balletAnt.overlay(this.balletDanceMotions[4],100)}}var J=new Z;J.start();
